<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telemetry System Domain Model Guide</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1, h2, h3 {
            color: #0066cc;
        }
        .entity {
            background-color: #f8f9fa;
            border-left: 4px solid #0066cc;
            padding: 10px 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        .relationship-diagram {
            background-color: #f9f9f9;
            padding: 20px;
            overflow-x: auto;
            border-radius: 4px;
            margin: 20px 0;
        }
        code {
            background-color: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .flow-diagram {
            flex: 1;
            min-width: 300px;
            background-color: #f0f7ff;
            padding: 15px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Telemetry System Domain Model Guide</h1>
    
    <h2>Overview</h2>
    <p>
        This telemetry system is designed to collect, store, and analyze data from various devices. 
        The domain model is structured to support device configuration, real-time data collection, 
        and comprehensive monitoring capabilities.
    </p>

    <div class="container">
        <div class="flow-diagram">
            <h3>Configuration Flow</h3>
            <ol>
                <li>Define device types with <code>DeviceDefinition</code> (templates)</li>
                <li>Create <code>SignalDefinition</code> instances for each parameter to monitor</li>
                <li>Configure <code>Datasource</code> instances for data acquisition</li>
                <li>Create <code>Device</code> instances mapped to definitions and datasources</li>
                <li>Configure device signals using <code>SignalConfiguration</code></li>
            </ol>
        </div>
        
        <div class="flow-diagram">
            <h3>Runtime Flow</h3>
            <ol>
                <li>Create <code>DeviceCommand</code> for reading/writing to devices</li>
                <li>Process commands through appropriate <code>Driver</code> implementations</li>
                <li>Store incoming data as <code>Reading</code> objects (time-series)</li>
                <li>Update <code>DeviceState</code> with current values</li>
                <li>Evaluate <code>AlarmCondition</code> and <code>ValidateCondition</code> rules</li>
            </ol>
        </div>
    </div>

    <h2>Core Entities</h2>
    
    <div class="entity">
        <h3>DeviceDefinition</h3>
        <p>Templates that define types of devices and their capabilities.</p>
        <table>
            <tr><th>Field</th><th>Type</th><th>Description</th></tr>
            <tr><td>id</td><td>String</td><td>Unique identifier</td></tr>
            <tr><td>name</td><td>String</td><td>Name of the device type</td></tr>
            <tr><td>description</td><td>String</td><td>Detailed description</td></tr>
            <tr><td>signals</td><td>List&lt;SignalDefinition&gt;</td><td>Signals this device type can handle</td></tr>
        </table>
    </div>
    
    <div class="entity">
        <h3>SignalDefinition</h3>
        <p>Defines a specific signal or parameter that can be monitored on a device.</p>
        <table>
            <tr><th>Field</th><th>Type</th><th>Description</th></tr>
            <tr><td>id</td><td>String</td><td>Unique identifier</td></tr>
            <tr><td>name</td><td>String</td><td>Display name</td></tr>
            <tr><td>description</td><td>String</td><td>Detailed description</td></tr>
            <tr><td>type</td><td>SignalDataType</td><td>Data type (NUMERIC, INTEGER, BOOLEAN, STRING)</td></tr>
            <tr><td>alarmsEnabled</td><td>boolean</td><td>Whether alarms are enabled for this signal</td></tr>
            <tr><td>alarmConditions</td><td>List&lt;AlarmCondition&gt;</td><td>Conditions that trigger alarms</td></tr>
            <tr><td>validateConditions</td><td>List&lt;ValidateCondition&gt;</td><td>Validation rules</td></tr>
            <tr><td>unit</td><td>String</td><td>Unit of measurement</td></tr>
        </table>
    </div>
    
    <div class="entity">
        <h3>Device</h3>
        <p>Represents a physical or virtual device in the system.</p>
        <table>
            <tr><th>Field</th><th>Type</th><th>Description</th></tr>
            <tr><td>id</td><td>String</td><td>Unique identifier</td></tr>
            <tr><td>name</td><td>String</td><td>Device name</td></tr>
            <tr><td>description</td><td>String</td><td>Detailed description</td></tr>
            <tr><td>location</td><td>String</td><td>Physical location</td></tr>
            <tr><td>active</td><td>boolean</td><td>Whether device is active</td></tr>
            <tr><td>deviceDefinitionId</td><td>String</td><td>Reference to device definition</td></tr>
            <tr><td>datasourceId</td><td>String</td><td>Reference to datasource</td></tr>
            <tr><td>signalConfigurations</td><td>List&lt;SignalConfiguration&gt;</td><td>Signal-specific configurations</td></tr>
        </table>
    </div>
    
    <div class="entity">
        <h3>SignalConfiguration</h3>
        <p>Configuration parameters for a specific signal on a device.</p>
        <table>
            <tr><th>Field</th><th>Type</th><th>Description</th></tr>
            <tr><td>signalId</td><td>String</td><td>Signal identifier</td></tr>
            <tr><td>signalProperties</td><td>List&lt;Property&gt;</td><td>Configuration properties</td></tr>
        </table>
    </div>
    
    <div class="entity">
        <h3>Datasource</h3>
        <p>Connection details for data acquisition from devices.</p>
        <table>
            <tr><th>Field</th><th>Type</th><th>Description</th></tr>
            <tr><td>id</td><td>String</td><td>Unique identifier</td></tr>
            <tr><td>name</td><td>String</td><td>Datasource name</td></tr>
            <tr><td>description</td><td>String</td><td>Detailed description</td></tr>
            <tr><td>driverId</td><td>String</td><td>Driver implementation to use</td></tr>
            <tr><td>active</td><td>boolean</td><td>Whether datasource is active</td></tr>
            <tr><td>configuration</td><td>List&lt;Property&gt;</td><td>Driver configuration properties</td></tr>
            <tr><td>connected</td><td>boolean</td><td>Connection status</td></tr>
        </table>
    </div>

    <h2>Runtime Data Entities</h2>
    
    <div class="entity">
        <h3>Reading</h3>
        <p>Time-series data collected from device signals.</p>
        <table>
            <tr><th>Field</th><th>Type</th><th>Description</th></tr>
            <tr><td>id</td><td>String</td><td>Unique identifier</td></tr>
            <tr><td>deviceId</td><td>String</td><td>Source device</td></tr>
            <tr><td>signalId</td><td>String</td><td>Signal identifier</td></tr>
            <tr><td>metaId</td><td>String</td><td>Composite ID for time-series (deviceId:signalId)</td></tr>
            <tr><td>timestamp</td><td>Date</td><td>Timestamp when reading was taken</td></tr>
            <tr><td>value</td><td>Object</td><td>Reading value</td></tr>
            <tr><td>numericValue</td><td>Double</td><td>Numeric representation for aggregations</td></tr>
            <tr><td>inAlarm</td><td>boolean</td><td>Whether reading is in alarm state</td></tr>
            <tr><td>alarmMessage</td><td>String</td><td>Alarm message if applicable</td></tr>
            <tr><td>alarmSeverity</td><td>AlarmSeverity</td><td>Alarm severity level</td></tr>
        </table>
    </div>
    
    <div class="entity">
        <h3>DeviceState</h3>
        <p>Current state of a device and its signals.</p>
        <table>
            <tr><th>Field</th><th>Type</th><th>Description</th></tr>
            <tr><td>id</td><td>String</td><td>Unique identifier</td></tr>
            <tr><td>deviceId</td><td>String</td><td>Associated device</td></tr>
            <tr><td>created</td><td>Date</td><td>Creation timestamp</td></tr>
            <tr><td>updated</td><td>Date</td><td>Last update timestamp</td></tr>
            <tr><td>signalStates</td><td>List&lt;SignalState&gt;</td><td>Current state of all signals</td></tr>
            <tr><td>connected</td><td>boolean</td><td>Connection status</td></tr>
            <tr><td>connectionStatus</td><td>String</td><td>Detailed connection status</td></tr>
            <tr><td>healthStatus</td><td>HealthStatus</td><td>Overall health status</td></tr>
        </table>
    </div>
    
    <div class="entity">
        <h3>DeviceCommand</h3>
        <p>Commands for reading from or writing to devices.</p>
        <table>
            <tr><th>Field</th><th>Type</th><th>Description</th></tr>
            <tr><td>id</td><td>String</td><td>Unique identifier</td></tr>
            <tr><td>datasourceId</td><td>String</td><td>Target datasource</td></tr>
            <tr><td>deviceId</td><td>String</td><td>Target device</td></tr>
            <tr><td>signalId</td><td>String</td><td>Target signal</td></tr>
            <tr><td>commandType</td><td>CommandType</td><td>READ or WRITE operation</td></tr>
            <tr><td>parameters</td><td>Map&lt;String, String&gt;</td><td>Command parameters</td></tr>
            <tr><td>status</td><td>CommandStatus</td><td>Execution status</td></tr>
        </table>
    </div>

    <h2>Condition Evaluation</h2>
    
    <div class="entity">
        <h3>AlarmCondition</h3>
        <p>Rules for determining alarm conditions on signals.</p>
        <table>
            <tr><th>Field</th><th>Type</th><th>Description</th></tr>
            <tr><td>id</td><td>String</td><td>Unique identifier</td></tr>
            <tr><td>name</td><td>String</td><td>Condition name</td></tr>
            <tr><td>code</td><td>String</td><td>Condition code</td></tr>
            <tr><td>description</td><td>String</td><td>Detailed description</td></tr>
            <tr><td>expression</td><td>Expression</td><td>MVEL expression to evaluate</td></tr>
            <tr><td>severity</td><td>AlarmSeverity</td><td>Alarm severity level</td></tr>
        </table>
    </div>
    
    <div class="entity">
        <h3>ValidateCondition</h3>
        <p>Rules for validating signal values.</p>
        <table>
            <tr><th>Field</th><th>Type</th><th>Description</th></tr>
            <tr><td>id</td><td>String</td><td>Unique identifier</td></tr>
            <tr><td>code</td><td>String</td><td>Condition code</td></tr>
            <tr><td>description</td><td>String</td><td>Detailed description</td></tr>
            <tr><td>expression</td><td>Expression</td><td>MVEL expression to evaluate</td></tr>
        </table>
    </div>
    
    <div class="entity">
        <h3>Expression</h3>
        <p>MVEL expression engine for evaluating conditions.</p>
        <table>
            <tr><th>Field</th><th>Type</th><th>Description</th></tr>
            <tr><td>expression</td><td>String</td><td>MVEL expression text</td></tr>
            <tr><td>description</td><td>String</td><td>Expression description</td></tr>
            <tr><td>compiledExpression</td><td>Serializable</td><td>Compiled form for efficient execution</td></tr>
        </table>
    </div>

    <h2>Entity Relationship Diagram</h2>
    
    <div class="relationship-diagram">
        <pre>
+-------------------+       +----------------------+       +------------------+
| DeviceDefinition  |<------| Device              |------>| Datasource       |
+-------------------+       +----------------------+       +------------------+
| id                |       | id                   |       | id               |
| name              |       | name                 |       | name             |
| description       |       | description          |       | description      |
| signals[]         |       | location             |       | driverId         |
+--------|----------+       | active               |       | active           |
         |                  | deviceDefinitionId   |       | configuration[]  |
         |                  | datasourceId         |       | connected        |
         |                  | signalConfigurations[]|       +------------------+
         |                  +----------------------+                ^
         |                            |                            |
         v                            v                            |
+-------------------+       +----------------------+               |
| SignalDefinition  |<------| SignalConfiguration  |               |
+-------------------+       +----------------------+               |
| id                |       | signalId             |               |
| name              |       | signalProperties[]   |               |
| description       |       +----------------------+               |
| type              |                |                             |
| alarmsEnabled     |                |                             |
| alarmConditions[] |                |                             |
| validateConditions[]               |                             |
+-------------------+                |                             |
         ^                           |                             |
         |                           |                             |
+-------------------+                |                             |
| AlarmCondition    |                |                             |
+-------------------+                |                             |
| id                |                |                             |
| name              |                |                             |
| code              |                |                             |
| description       |                |                             |
| expression        |                |                             |
| severity          |                |                             |
+-------------------+                |                             |
                                    |                             |
+-------------------+       +----------------------+       +------------------+
| DeviceState       |<------| DeviceCommand        |------>| Driver           |
+-------------------+       +----------------------+       +------------------+
| id                |       | id                   |       | getId()          |
| deviceId          |       | datasourceId         |       | initialize()     |
| created           |       | deviceId             |       | connect()        |
| updated           |       | signalId             |       | disconnect()     |
| signalStates[]    |       | commandType          |       | isConnected()    |
| connected         |       | parameters           |       | read()           |
| connectionStatus  |       | status               |       | write()          |
| healthStatus      |       +----------------------+       +------------------+
+--------|----------+                |                             |
         |                           |                             |
         v                           |                             |
+-------------------+                |                             |
| SignalState       |                |                             |
+-------------------+                |                             |
| signalId          |                |                             |
| lastReading       |<---------------+-----------------------------+
+-------------------+                |
         ^                           |
         |                           |
+-------------------+                |
| Reading           |<---------------+
+-------------------+
| id                |
| deviceId          |
| signalId          |
| metaId            |
| timestamp         |
| value             |
| numericValue      |
| inAlarm           |
| alarmMessage      |
| alarmSeverity     |
+-------------------+
        </pre>
    </div>

    <h2>Key Patterns</h2>
    
    <h3>Signal Configuration Pattern</h3>
    <p>
        The system uses a flexible configuration approach where devices are based on 
        device definitions (templates) that define available signals. Each device then has 
        specific configurations for each signal, enabling customization while maintaining 
        consistency across similar devices.
    </p>
    
    <h3>Time-Series Data Pattern</h3>
    <p>
        The <code>Reading</code> class is optimized for MongoDB time-series collections with:
    </p>
    <ul>
        <li>Time-field annotations for efficient temporal queries</li>
        <li>Meta-field for organizing readings by device/signal</li>
        <li>Time bucket fields (year, month, day, hour) for optimized time-range queries</li>
        <li>Numeric value extraction for efficient aggregation</li>
    </ul>
    
    <h3>Command Pattern</h3>
    <p>
        The system implements the Command pattern through <code>DeviceCommand</code> objects, 
        which encapsulate reading and writing operations to devices. This provides:
    </p>
    <ul>
        <li>Separation of command specification from execution</li>
        <li>Audit trail of all operations</li>
        <li>Retry capability for failed operations</li>
        <li>Status tracking throughout the command lifecycle</li>
    </ul>
    
    <h3>Expression Evaluation Pattern</h3>
    <p>
        The system uses MVEL expressions for flexible rule evaluation in alarm and validation conditions.
        This provides a powerful way to express complex conditions without requiring code changes.
    </p>

    <h2>Best Practices</h2>
    <ul>
        <li>Use <code>@NonNull</code> annotations for required fields</li>
        <li>Initialize collections with <code>@Builder.Default</code> to prevent null references</li>
        <li>Use transient fields for runtime-only data that shouldn't be persisted</li>
        <li>Follow consistent naming patterns for audit fields (createdAt, updatedAt)</li>
        <li>Use appropriate validation constraints for entity fields</li>
    </ul>

</body>
</html> 